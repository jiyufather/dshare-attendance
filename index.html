<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D.Share ì‚¬ì—…ê¸°íšíŒ€ ê·¼íƒœê´€ë¦¬ (ê³µìœ í˜•)</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00AE99;
            --primary-dark: #008c7a;
            --bg: #f0f4f7;
            --white: #ffffff;
            --text: #2c3e50;
            --border: #e1e4e8;
            --danger: #ff6b6b;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 30px; font-weight: 700; }

        /* íƒ­ & ë²„íŠ¼ */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; }
        .tab-btn { padding: 14px 28px; border: none; border-radius: 12px; background: #e9ecef; font-weight: 600; cursor: pointer; color: #7f8c8d; transition: 0.3s; font-size: 16px; }
        .tab-btn:hover { background: #dfe4ea; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--white); border-radius: 16px; padding: 25px; box-shadow: var(--shadow-sm); margin-bottom: 25px; border: 1px solid white; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; font-family: 'Pretendard'; }
        .btn-secondary { background: #f1f3f5; color: #495057; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { padding: 6px 10px; font-size: 12px; background: #edf2f7; color: #555; }

        select, input[type="text"] { padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-family: 'Pretendard'; font-size: 13px; background: #fcfcfc; }
        select:focus, input:focus { outline: none; border-color: var(--primary); }

        .time-select-group { display: flex; align-items: center; gap: 4px; background: #f8f9fa; padding: 4px; border-radius: 6px; border: 1px solid #eee; margin-top: 4px; }
        .time-select { padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white; cursor: pointer; }
        .time-separator { font-weight: bold; color: #888; font-size: 12px; }

        .week-table-container { overflow-x: auto; border-radius: 12px; box-shadow: var(--shadow-sm); }
        .week-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }
        .week-table th, .week-table td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 10px; text-align: center; vertical-align: top; background: white; }
        .week-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #555; }
        .week-table .name-col { position: sticky; left: 0; z-index: 20; background: #f8f9fa; font-weight: 700; border-right: 2px solid var(--border); color: var(--text); min-width: 80px; }
        .today-header { color: var(--primary) !important; font-weight: 800 !important; background: #e6f7f5 !important; }

        .calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .cal-day-header { text-align: center; font-weight: 600; padding: 10px; background: #f1f3f5; border-radius: 8px; margin-bottom: 10px; }
        .cal-cell { background: white; border: 1px solid var(--border); border-radius: 12px; min-height: 120px; padding: 10px; display: flex; flex-direction: column; gap: 6px; box-shadow: var(--shadow-sm); }
        .cal-today { border: 2px solid var(--primary); background: #f0fcf9; }
        .cal-member-tag { font-size: 11px; padding: 5px 8px; background: #f0f2f5; border-radius: 6px; border-left: 3px solid var(--primary); display: flex; justify-content: space-between; cursor: pointer; }
        .cal-member-tag:hover { background: #e2e6ea; }
        .cal-member-tag.default-val { border-left-color: #ccc; background: #f9f9f9; color: #888; }
        .tag-vacation { border-left-color: var(--danger); background: #fff5f5; color: var(--danger); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 25px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .admin-list-item { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .hidden { display: none !important; }

        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; font-weight: bold; color: var(--primary); font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <h1>ğŸ“… D.Share ì‚¬ì—…ê¸°íšíŒ€ ê·¼íƒœê´€ë¦¬</h1>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('week')">ì£¼ê°„ ë³´ê¸° (ì…ë ¥)</button>
        <button class="tab-btn" onclick="switchTab('month')">ì›”ê°„ ë³´ê¸° (ìº˜ë¦°ë”)</button>
        <button class="tab-btn" onclick="switchTab('admin')">âš™ï¸ ê´€ë¦¬ì</button>
    </div>

    <div id="tab-week" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <h2 id="weekTitle">ì´ë²ˆ ì£¼ ê·¼íƒœ ì…ë ¥</h2>
                <div>
                    <button class="btn btn-secondary" onclick="moveWeek(-1)">â—€ ì´ì „ì£¼</button>
                    <button class="btn btn-secondary" onclick="moveWeek(0)">ì˜¤ëŠ˜</button>
                    <button class="btn btn-secondary" onclick="moveWeek(1)">ë‹¤ìŒì£¼ â–¶</button>
                </div>
            </div>
            <p style="text-align:right; font-size:12px; color:var(--primary); font-weight:bold;">ğŸŸ¢ ì‹¤ì‹œê°„ ìë™ ì €ì¥/ë™ê¸°í™” ì¤‘</p>
            <div class="week-table-container">
                <table class="week-table">
                    <thead><tr id="weekHeader"></tr></thead>
                    <tbody id="weekBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-month" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 id="monthTitle">2026ë…„ 2ì›”</h2>
                <div>
                    <button class="btn btn-secondary" onclick="moveMonth(-1)">â—€ ì´ì „ë‹¬</button>
                    <button class="btn btn-secondary" onclick="moveMonth(1)">ë‹¤ìŒë‹¬ â–¶</button>
                </div>
            </div>
            <p style="text-align:right; font-size:12px; color:#999; margin-top:-10px;">* íšŒìƒ‰: ê¸°ë³¸ê°’ / ìƒ‰ìƒ: ì €ì¥ëœ ê°’</p>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 5px;">
                <div class="cal-day-header">ì›”</div><div class="cal-day-header">í™”</div><div class="cal-day-header">ìˆ˜</div><div class="cal-day-header">ëª©</div><div class="cal-day-header">ê¸ˆ</div>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
    </div>

    <div id="tab-admin" class="tab-content">
        <div id="adminLogin" class="card" style="text-align: center; padding: 60px 20px;">
            <h3>ğŸ”’ ê´€ë¦¬ì ì ‘ê·¼</h3>
            <button class="btn btn-primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
        <div id="adminPanel" class="hidden">
            <div class="card">
                <h2>ğŸ‘¥ ì¸ì› ë° ê¸°ë³¸ê°’ ì„¤ì • (ì‹¤ì‹œê°„ ë°˜ì˜)</h2>
                <div style="display:flex; gap:10px; margin-bottom: 25px;">
                    <input type="text" id="newMemberName" placeholder="ì´ë¦„ ì…ë ¥" style="flex-grow:1;">
                    <button class="btn btn-primary" onclick="addMember()">+ ì¶”ê°€</button>
                </div>
                <div id="memberListArea"></div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 style="text-align:center; color:var(--primary); margin-top:0;">âœï¸ ê·¼íƒœ ìˆ˜ì •</h3>
            <input type="hidden" id="modalDateKey">
            <input type="hidden" id="modalMember">
            <p id="modalInfoText" style="text-align:center; font-weight:bold; color:#555;"></p>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:600;">ê·¼ë¬´ í˜•íƒœ</label>
                <select id="modalType" style="width:100%" onchange="toggleModalTimeInputs()">
                    <option value="work">ğŸ”µ ì •ìƒì¶œê·¼</option>
                    <option value="half_am">ğŸŸ¡ ì˜¤ì „ë°˜ì°¨</option>
                    <option value="half_pm">ğŸŸ  ì˜¤í›„ë°˜ì°¨</option>
                    <option value="q_am">ğŸŒ“ ì˜¤ì „ë°˜ë°˜</option>
                    <option value="q_pm">ğŸŒ— ì˜¤í›„ë°˜ë°˜</option>
                    <option value="vacation">ğŸ”´ ì—°ì°¨</option>
                </select>
            </div>
            <div id="modalTimeGroup" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:600;">ì‹œê°„ ì„¤ì • (5ë¶„ ë‹¨ìœ„)</label>
                <div id="modalTimePickers"></div>
            </div>
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="saveModalData()">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="toast">âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // === 1. Firebase ì„¤ì • (ì£¼ì‹  í‚¤ ì ìš© ì™„ë£Œ) ===
        const firebaseConfig = {
            apiKey: "AIzaSyBmqhFcRdQ7kOuvEKrJzaKrKR5lWlcQ16w",
            authDomain: "dshare-attendance.firebaseapp.com",
            projectId: "dshare-attendance",
            storageBucket: "dshare-attendance.firebasestorage.app",
            messagingSenderId: "247107495551",
            appId: "1:247107495551:web:8c58c06e368d241d43414a"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === 2. ì „ì—­ ë³€ìˆ˜ ===
        let currentViewDate = new Date();
        const DEFAULT_MEMBERS = [
            { name: "ì‹ ì¢…ì›", defStart: "09:00", defEnd: "18:00" },
            { name: "ìœ ì¬ìš±", defStart: "09:00", defEnd: "18:00" },
            { name: "ê³ ì†Œë¯¸", defStart: "09:00", defEnd: "18:00" },
            { name: "ê¹€ì§€í˜œ", defStart: "09:00", defEnd: "18:00" },
            { name: "ì‹ ë™í˜„", defStart: "09:00", defEnd: "18:00" },
            { name: "ì¥ì§€ì›…", defStart: "09:00", defEnd: "18:00" },
            { name: "ìµœìœ¤ì„œ", defStart: "09:00", defEnd: "18:00" }
        ];
        
        // ë°ì´í„° ìƒíƒœ (Firebaseì™€ ë™ê¸°í™”ë¨)
        window.members = [];
        window.records = {};
        window.isAdmin = false;

        const MINUTES = ["00", "05", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55"];
        // ì¶œê·¼ 08~15, í‡´ê·¼ 12~21
        const START_HOURS = []; for(let i=8; i<=15; i++) START_HOURS.push(String(i).padStart(2,'0'));
        const END_HOURS = []; for(let i=12; i<=21; i++) END_HOURS.push(String(i).padStart(2,'0'));

        // === 3. Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ===
        // ì•± ì‹œì‘ ì‹œ ì‹¤í–‰
        async function initApp() {
            // A. ë©¤ë²„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
            onSnapshot(doc(db, "dshare", "members"), (docSnap) => {
                if (docSnap.exists()) {
                    window.members = docSnap.data().list;
                } else {
                    // ë°ì´í„° ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ ì„¸íŒ…
                    window.members = JSON.parse(JSON.stringify(DEFAULT_MEMBERS));
                    setDoc(doc(db, "dshare", "members"), { list: window.members });
                }
                renderAll(); // ë°ì´í„° ë°”ë€Œë©´ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            });

            // B. ê¸°ë¡ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
            onSnapshot(doc(db, "dshare", "records"), (docSnap) => {
                document.getElementById('loading').style.display = 'none'; // ë¡œë”© ë
                if (docSnap.exists()) {
                    window.records = docSnap.data().data;
                } else {
                    window.records = {};
                    setDoc(doc(db, "dshare", "records"), { data: {} });
                }
                renderAll();
            });
        }
        initApp(); // ì‹¤í–‰

        // === 4. í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ë“¤ ===
        function renderAll() {
            renderWeekView();
            renderMonthView();
            if(window.isAdmin) renderAdminMembers();
        }

        // Firebaseì— ë°ì´í„° ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (LocalStorage ëŒ€ì²´)
        async function saveRecordsToDB() {
            try {
                await setDoc(doc(db, "dshare", "records"), { data: window.records }, { merge: true });
                showToast();
            } catch(e) { console.error("Error adding document: ", e); }
        }

        async function saveMembersToDB() {
            try {
                await setDoc(doc(db, "dshare", "members"), { list: window.members });
                showToast();
            } catch(e) { console.error("Error adding document: ", e); }
        }

        // ------------------------------------------
        // ê¸°ì¡´ UI ë¡œì§ (window. í•¨ìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ëª¨ë“ˆ ë°–ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ í•¨)
        // ------------------------------------------

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            renderAll();
        }

        // === ì‹œê°„ ì„ íƒê¸° ìƒì„± ===
        window.createTimeSelectHTML = function(idPrefix, timeValue, onChangeFuncStr, type) {
            let [h, m] = timeValue ? timeValue.split(':') : ["09", "00"];
            let hoursArr = (type === 'start') ? START_HOURS : END_HOURS;
            if(!hoursArr.includes(h)) hoursArr = [...hoursArr, h].sort(); // ë²”ìœ„ ë°– ê°’ ì²˜ë¦¬

            let hOptions = hoursArr.map(val => `<option value="${val}" ${val==h?'selected':''}>${val}</option>`).join('');
            let mOptions = MINUTES.map(val => `<option value="${val}" ${val==m?'selected':''}>${val}</option>`).join('');

            return `
                <div class="time-select-group" id="${idPrefix}_group">
                    <select id="${idPrefix}_h" class="time-select" onchange="${onChangeFuncStr}">${hOptions}</select>
                    <span class="time-separator">:</span>
                    <select id="${idPrefix}_m" class="time-select" onchange="${onChangeFuncStr}">${mOptions}</select>
                </div>`;
        }

        window.getTimeFromSelects = function(idPrefix) {
            const h = document.getElementById(`${idPrefix}_h`).value;
            const m = document.getElementById(`${idPrefix}_m`).value;
            return `${h}:${m}`;
        }

        window.setTimeSelects = function(idPrefix, timeStr) {
            let [h, m] = timeStr.split(':');
            let mNum = Math.round(Number(m)/5)*5;
            if(mNum===60) { mNum=0; h=Number(h)+1; }
            m = String(mNum).padStart(2,'0');
            h = String(h).padStart(2,'0');

            const hEl = document.getElementById(`${idPrefix}_h`);
            const mEl = document.getElementById(`${idPrefix}_m`);
            if(hEl && mEl) {
                // ì˜µì…˜ ì—†ìœ¼ë©´ ì¶”ê°€
                if(!Array.from(hEl.options).some(op=>op.value==h)) hEl.add(new Option(h,h));
                hEl.value = h; mEl.value = m;
            }
        }

        // === ì£¼ê°„ ë³´ê¸° ===
        function renderWeekView() {
            const tbody = document.getElementById('weekBody');
            const thead = document.getElementById('weekHeader');
            tbody.innerHTML = "";
            
            const monday = getMonday(currentViewDate);
            const weekDates = [];
            const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
            
            thead.innerHTML = '<th class="name-col">ì´ë¦„</th>';
            for(let i=0; i<5; i++) {
                let d = new Date(monday);
                d.setDate(monday.getDate() + i);
                let dateStr = d.toISOString().split('T')[0];
                weekDates.push({ date: d, key: dateStr });
                let th = document.createElement('th');
                th.innerHTML = `${d.getMonth()+1}/${d.getDate()} (${dayNames[i]})`;
                if(dateStr === new Date().toISOString().split('T')[0]) th.classList.add('today-header');
                thead.appendChild(th);
            }
            document.getElementById('weekTitle').innerText = `${monday.getMonth()+1}ì›” ${getWeekNumber(monday)}ì£¼ì°¨ ì…ë ¥`;

            window.members.forEach(mObj => {
                let tr = document.createElement('tr');
                tr.innerHTML = `<td class="name-col">${mObj.name}</td>`;
                weekDates.forEach(day => {
                    let td = document.createElement('td');
                    let data = (window.records[day.key] && window.records[day.key][mObj.name]) || { type: 'work', start: mObj.defStart, end: mObj.defEnd };
                    let idBase = `cell_${day.key}_${mObj.name}`;

                    let typeHtml = `
                        <select id="${idBase}_type" onchange="handleTypeChange('${day.key}', '${mObj.name}', this.value)" style="width:100%; margin-bottom:4px;">
                            <option value="work" ${data.type==='work'?'selected':''}>ğŸ”µ ì •ìƒ</option>
                            <option value="half_am" ${data.type==='half_am'?'selected':''}>ğŸŸ¡ ì˜¤ì „ë°˜</option>
                            <option value="half_pm" ${data.type==='half_pm'?'selected':''}>ğŸŸ  ì˜¤í›„ë°˜</option>
                            <option value="q_am" ${data.type==='q_am'?'selected':''}>ğŸŒ“ ì˜¤ì „ë°˜ë°˜</option>
                            <option value="q_pm" ${data.type==='q_pm'?'selected':''}>ğŸŒ— ì˜¤í›„ë°˜ë°˜</option>
                            <option value="vacation" ${data.type==='vacation'?'selected':''}>ğŸ”´ ì—°ì°¨</option>
                        </select>`;
                    
                    let startHtml = createTimeSelectHTML(`${idBase}_start`, data.start, `handleTimeChange('${day.key}', '${mObj.name}', 'start')`, 'start');
                    let endHtml = createTimeSelectHTML(`${idBase}_end`, data.end, `handleTimeChange('${day.key}', '${mObj.name}', 'end')`, 'end');

                    td.innerHTML = `${typeHtml} <div id="${idBase}_time_box" style="display:${data.type==='vacation'?'none':'block'}">${startHtml} ${endHtml}</div>`;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        window.handleTypeChange = function(dateKey, name, typeVal) {
            updateRecord(dateKey, name, 'type', typeVal);
            document.getElementById(`cell_${dateKey}_${name}_time_box`).style.display = (typeVal==='vacation') ? 'none' : 'block';
            saveRecordsToDB(); // DB ì €ì¥
        }

        window.handleTimeChange = function(dateKey, name, which) {
            let idBase = `cell_${dateKey}_${name}`;
            let val = getTimeFromSelects(`${idBase}_${which}`);
            if(which === 'start') { // ìë™ í‡´ê·¼ ê³„ì‚°
                let [h, m] = val.split(':').map(Number);
                let endH = (h + 9) % 24;
                let endStr = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                setTimeSelects(`${idBase}_end`, endStr);
                updateRecord(dateKey, name, 'end', endStr);
            }
            updateRecord(dateKey, name, which, val);
            saveRecordsToDB(); // DB ì €ì¥
        }

        function updateRecord(date, name, field, val) {
            if(!window.records[date]) window.records[date] = {};
            if(!window.records[date][name]) {
                const m = window.members.find(x => x.name === name) || { defStart: "09:00", defEnd: "18:00" };
                window.records[date][name] = { type: 'work', start: m.defStart, end: m.defEnd };
            }
            window.records[date][name][field] = val;
        }

        // === ì›”ê°„ ë³´ê¸° ===
        function renderMonthView() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = "";
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            document.getElementById('monthTitle').innerText = `${year}ë…„ ${month+1}ì›”`;

            const lastDay = new Date(year, month+1, 0).getDate();
            const firstDayObj = new Date(year, month, 1);
            let firstDayOfWeek = firstDayObj.getDay(); 
            let padding = (firstDayOfWeek >= 1 && firstDayOfWeek <= 5) ? firstDayOfWeek - 1 : 0;
            
            for(let i=0; i<padding; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=lastDay; d++) {
                let dateObj = new Date(year, month, d);
                let dayOfWeek = dateObj.getDay();
                if(dayOfWeek === 0 || dayOfWeek === 6) continue;

                let dateKey = dateObj.toISOString().split('T')[0];
                let html = `<div class="cal-cell ${dateKey===new Date().toISOString().split('T')[0]?'cal-today':''}">
                    <span style="font-weight:bold; color:#555;">${d}ì¼</span>
                    <div style="flex-grow:1; overflow-y:auto; display:flex; flex-direction:column; gap:4px;">`;

                window.members.forEach(m => {
                    let hasRecord = window.records[dateKey] && window.records[dateKey][m.name];
                    let r = hasRecord ? window.records[dateKey][m.name] : { type: 'work', start: m.defStart, end: m.defEnd };
                    let isVac = r.type==='vacation';
                    let timeTxt = isVac ? 'ì—°ì°¨' : `${r.start}~${r.end}`;
                    let styleClass = hasRecord ? (isVac?'tag-vacation':'') : 'default-val';
                    
                    html += `<div class="cal-member-tag ${styleClass}" onclick="openModal('${dateKey}', '${m.name}')">
                        <span style="font-weight:600">${m.name}</span><span>${timeTxt}</span></div>`;
                });
                html += `</div></div>`;
                grid.innerHTML += html;
            }
        }

        // === ëª¨ë‹¬ ===
        window.openModal = function(dateKey, name) {
            let mObj = window.members.find(m => m.name === name);
            let data = (window.records[dateKey] && window.records[dateKey][name]) || { type: 'work', start: mObj.defStart, end: mObj.defEnd };
            
            document.getElementById('modalDateKey').value = dateKey;
            document.getElementById('modalMember').value = name;
            document.getElementById('modalInfoText').innerText = `${dateKey} / ${name}`;
            document.getElementById('modalType').value = data.type;
            
            let timeBox = document.getElementById('modalTimePickers');
            timeBox.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
                    ${createTimeSelectHTML('modal_start', data.start, "calcModalEnd()", 'start')}
                    <span>~</span>
                    ${createTimeSelectHTML('modal_end', data.end, "", 'end')}
                </div>`;
            
            toggleModalTimeInputs();
            document.getElementById('editModal').classList.add('active');
        }

        window.closeModal = function(e) { 
            if(e && e.target !== e.currentTarget) return;
            document.getElementById('editModal').classList.remove('active'); 
        }

        window.toggleModalTimeInputs = function() {
            let type = document.getElementById('modalType').value;
            document.getElementById('modalTimeGroup').style.display = (type==='vacation'?'none':'block');
        }

        window.calcModalEnd = function() {
            let startVal = getTimeFromSelects('modal_start');
            let [h, m] = startVal.split(':').map(Number);
            let endH = (h + 9) % 24;
            let endStr = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            setTimeSelects('modal_end', endStr);
        }

        window.saveModalData = function() {
            let date = document.getElementById('modalDateKey').value;
            let name = document.getElementById('modalMember').value;
            let type = document.getElementById('modalType').value;
            let start = getTimeFromSelects('modal_start');
            let end = getTimeFromSelects('modal_end');
            
            updateRecord(date, name, 'type', type);
            updateRecord(date, name, 'start', start);
            updateRecord(date, name, 'end', end);
            saveRecordsToDB(); // DB ì €ì¥
            closeModal();
        }

        // === ê´€ë¦¬ì ===
        window.adminLogin = function() {
            if(prompt("ID")==='dshare' && prompt("PW")==='Dshare123!') {
                window.isAdmin=true; 
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                renderAdminMembers();
            } else alert("ì‹¤íŒ¨");
        }

        window.renderAdminMembers = function() {
            const area = document.getElementById('memberListArea');
            area.innerHTML = window.members.map((m, i) => `
                <div class="admin-list-item">
                    <span style="font-weight:bold; min-width:60px;">${m.name}</span>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span style="font-size:12px;">ê¸°ë³¸:</span>
                        ${createTimeSelectHTML(`admin_def_start_${i}`, m.defStart, `updateDef(${i}, 'defStart')`, 'start')}
                        ~
                        ${createTimeSelectHTML(`admin_def_end_${i}`, m.defEnd, `updateDef(${i}, 'defEnd')`, 'end')}
                    </div>
                    <div>
                        <button class="btn btn-icon" onclick="moveMember(${i},-1)">â–²</button>
                        <button class="btn btn-icon" onclick="moveMember(${i},1)">â–¼</button>
                        <button class="btn btn-danger" style="padding:5px 10px; font-size:12px;" onclick="delMember(${i})">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }
        
        window.updateDef = function(idx, field) {
            let idPrefix = (field === 'defStart') ? `admin_def_start_${idx}` : `admin_def_end_${idx}`;
            window.members[idx][field] = getTimeFromSelects(idPrefix);
            saveMembersToDB(); // ë©¤ë²„ DB ì €ì¥
        };

        window.addMember = function() {
            let n = document.getElementById('newMemberName').value.trim();
            if(n && !window.members.some(m=>m.name===n)) {
                window.members.push({name:n, defStart:"09:00", defEnd:"18:00"});
                document.getElementById('newMemberName').value="";
                saveMembersToDB(); 
            }
        }
        window.delMember = function(i) { if(confirm("ì‚­ì œ?")) { window.members.splice(i,1); saveMembersToDB(); } }
        window.moveMember = function(i, dir) {
            if(i+dir<0 || i+dir>=window.members.length) return;
            [window.members[i], window.members[i+dir]] = [window.members[i+dir], window.members[i]];
            saveMembersToDB();
        }

        // === Utils ===
        function showToast() {
            let t = document.getElementById("toast");
            t.className = "show";
            setTimeout(()=> t.className=t.className.replace("show",""), 2000);
        }
        function getMonday(d) { d=new Date(d); let day=d.getDay(), diff=d.getDate()-day+(day==0?-6:1); return new Date(d.setDate(diff)); }
        function getWeekNumber(d) { let onejan=new Date(d.getFullYear(),0,1); return Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); }
        window.moveWeek = function(n) { currentViewDate.setDate(currentViewDate.getDate()+n*7); renderWeekView(); }
        window.moveMonth = function(n) { currentViewDate.setMonth(currentViewDate.getMonth()+n); renderMonthView(); }
    </script>
</body>
</html>